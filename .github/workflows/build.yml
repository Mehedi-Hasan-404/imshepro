name: Build Android App

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # Allows you to trigger manually from GitHub interface

jobs:
  build:
    name: Build APKs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Grant Execute Permission for Gradlew
        run: chmod +x gradlew

      # CRITICAL STEP: Create google-services.json
      # The build will FAIL if you have not added the GOOGLE_SERVICES_JSON secret.
      - name: Create google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -z "$GOOGLE_SERVICES_JSON" ]; then
            echo "ERROR: GOOGLE_SERVICES_JSON secret is missing!"
            echo "Please go to Settings > Secrets and variables > Actions and add it."
            exit 1
          fi
          echo "$GOOGLE_SERVICES_JSON" > app/google-services.json
          echo "google-services.json created successfully."

      # Step to decode Keystore (Only needed for Signed Release Builds)
      - name: Decode Keystore
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          mkdir -p keystore
          echo "$KEYSTORE_BASE64" | base64 -d > keystore/keystore.jks

      # Build the Debug APK (Always runs)
      - name: Build Debug APK
        run: ./gradlew assembleDebug --stacktrace

      # Build Release APK (Only runs if a keystore is provided)
      - name: Build Release APK
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file=$(pwd)/keystore/keystore.jks \
              -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
              -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
              -Pandroid.injected.signing.key.password=$KEY_PASSWORD

      # Upload Artifacts (Download your APKs here after the build finishes)
      - name: Upload APKs
        uses: actions/upload-artifact@v4
        with:
          name: android-app-apks
          path: app/build/outputs/apk/**/*.apk
          retention-days: 14
